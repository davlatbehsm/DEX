<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>DEX 8.0 - ULTIMATE</title>
<style>
:root {
    --bg: #0e1621; --card: #17212b; --primary: #2481cc; --text: #ffffff;
    --text-dim: #708499; --msg-out: #2b5278; --msg-in: #182533; --red: #e53935;
}
* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
body { margin: 0; background: #000; color: var(--text); font-family: -apple-system, sans-serif; height: 100dvh; overflow: hidden; }

.app { width: 100%; height: 100%; max-width: 500px; margin: 0 auto; background: var(--bg); display: flex; flex-direction: column; position: relative; }

/* –≠–ö–†–ê–ù–´ */
.screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); display: none; flex-direction: column; z-index: 10; }
.screen.active { display: flex; }

header { height: 60px; background: var(--card); display: flex; align-items: center; padding: 0 16px; justify-content: space-between; z-index: 20; }
.content { flex: 1; overflow-y: auto; padding-bottom: 80px; }

/* –¢–ê–ë –ë–ê–† */
.tab-bar { height: 65px; background: var(--card); display: flex; border-top: 1px solid #000; padding-bottom: env(safe-area-inset-bottom); }
.tab { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 11px; color: var(--text-dim); cursor: pointer; }
.tab.active { color: var(--primary); }

/* –°–ü–ò–°–ö–ò */
.list-item { display: flex; align-items: center; padding: 12px 16px; border-bottom: 1px solid #00000030; cursor: pointer; }
.avatar { width: 50px; height: 50px; border-radius: 50%; background: var(--primary); display: flex; align-items: center; justify-content: center; font-size: 20px; font-weight: bold; margin-right: 15px; flex-shrink: 0; }

/* –ß–ê–¢ */
.bubble { max-width: 85%; padding: 8px 14px; border-radius: 15px; margin-bottom: 4px; font-size: 15px; line-height: 1.4; }
.me { background: var(--msg-out); align-self: flex-end; border-bottom-right-radius: 4px; margin-left: auto; }
.other { background: var(--msg-in); align-self: flex-start; border-bottom-left-radius: 4px; }

/* –§–û–†–ú–´ */
.auth-box { padding: 40px 20px; display: flex; flex-direction: column; gap: 15px; height: 100%; justify-content: center; }
input { background: #242f3d; border: 1px solid #242f3d; color: #fff; padding: 15px; border-radius: 10px; font-size: 16px; width: 100%; }
.btn { background: var(--primary); color: #fff; border: none; padding: 15px; border-radius: 10px; font-weight: bold; cursor: pointer; }

</style>
</head>
<body>

<div class="app">
    <div id="scr-auth" class="screen">
        <div class="auth-box">
            <h1 style="text-align:center; margin:0; font-size:48px; color:var(--primary)">DEX</h1>
            <p style="text-align:center; color:var(--text-dim); margin-bottom:20px">Security & Privacy</p>
            <input id="uIn" placeholder="–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è">
            <input id="pIn" type="password" placeholder="–ü–∞—Ä–æ–ª—å">
            <button class="btn" onclick="UI.handleAuth()">–í–æ–π—Ç–∏ / –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
        </div>
    </div>

    <div id="scr-main" class="screen">
        <header><div style="font-weight:bold; font-size:19px" id="hTitle">–ß–∞—Ç—ã</div></header>
        
        <div id="view-chats" class="content"></div>
        <div id="view-search" class="content" style="display:none; padding:15px">
            <input id="sIn" placeholder="–ù–∞–π—Ç–∏ —á–µ–ª–æ–≤–µ–∫–∞..." oninput="UI.search()">
            <div id="sRes" style="margin-top:10px"></div>
        </div>
        <div id="view-prof" class="content" style="display:none; padding:30px; text-align:center">
            <div id="myAv" class="avatar" style="width:100px; height:100px; margin:0 auto 20px; font-size:40px"></div>
            <h2 id="myName"></h2>
            <button class="btn" style="width:100%; background:#242f3d" onclick="UI.copyID()">–ú–æ–π ID –¥–ª—è –¥—Ä—É–≥–∞</button>
            <button class="btn" style="width:100%; background:#242f3d; margin-top:10px" onclick="UI.addID()">–î–æ–±–∞–≤–∏—Ç—å –¥—Ä—É–≥–∞ –ø–æ ID</button>
            <button class="btn" style="width:100%; background:var(--red); margin-top:30px" onclick="UI.logout()">–í—ã–π—Ç–∏ –∏–∑ —Å–∏—Å—Ç–µ–º—ã</button>
        </div>

        <div class="tab-bar">
            <div class="tab active" onclick="UI.tab('chats', this)"><span>üí¨</span>–ß–∞—Ç—ã</div>
            <div class="tab" onclick="UI.tab('search', this)"><span>üîç</span>–ü–æ–∏—Å–∫</div>
            <div class="tab" onclick="UI.tab('prof', this)"><span>üë§</span>–ü—Ä–æ—Ñ–∏–ª—å</div>
        </div>
    </div>

    <div id="scr-chat" class="screen">
        <header>
            <div style="display:flex; align-items:center; gap:12px">
                <div onclick="UI.closeChat()" style="cursor:pointer; font-size:24px">‚Üê</div>
                <div id="cName" style="font-weight:bold">–ß–∞—Ç</div>
            </div>
        </header>
        <div id="mList" class="content" style="padding:15px; display:flex; flex-direction:column; gap:4px"></div>
        <div style="padding:10px; background:var(--card); display:flex; gap:10px">
            <input id="mIn" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." style="margin:0">
            <button onclick="UI.send()" style="background:var(--primary); border:none; color:#fff; width:50px; border-radius:10px">‚û§</button>
        </div>
    </div>
</div>

<script>
// –ì–õ–û–ë–ê–õ–¨–ù–ê–Ø –ë–ê–ó–ê –î–ê–ù–ù–´–• - –¢–ï–ü–ï–†–¨ –û–î–ù–ê –ù–ê–í–°–ï–ì–î–ê
const DB = {
    me: null,
    store: JSON.parse(localStorage.getItem('dex_final_storage')) || { users: {}, chats: {} },
    save() { localStorage.setItem('dex_final_storage', JSON.stringify(this.store)); },
    cid(u1, u2) { return [u1, u2].sort().join('::'); }
};

const UI = {
    // –í—Ö–æ–¥ –∏ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
    handleAuth() {
        const u = uIn.value.trim(), p = pIn.value.trim();
        if(!u || !p) return alert("–ó–∞–ø–æ–ª–Ω–∏ –≤—Å–µ –ø–æ–ª—è");

        if(!DB.store.users[u]) {
            DB.store.users[u] = { pass: p };
            // –°—Ä–∞–∑—É —Å–æ–∑–¥–∞–µ–º –∏–∑–±—Ä–∞–Ω–Ω–æ–µ
            DB.store.chats[DB.cid(u, u)] = [{f:'System', t:'–¢–≤–æ–∏ –ª–∏—á–Ω—ã–µ –∑–∞–º–µ—Ç–∫–∏'}];
            DB.save();
        } else if(DB.store.users[u].pass !== p) {
            return alert("–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å");
        }
        
        this.login(u);
    },

    login(u) {
        DB.me = u;
        localStorage.setItem('dex_active_session', u);
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        scr_main.classList.add('active');
        myName.innerText = u;
        myAv.innerText = u[0].toUpperCase();
        this.renderChats();
    },

    logout() {
        localStorage.removeItem('dex_active_session');
        location.reload();
    },

    // –¢–∞–±—ã
    tab(t, el) {
        document.querySelectorAll('.tab').forEach(x => x.classList.remove('active'));
        el.classList.add('active');
        ['chats', 'search', 'prof'].forEach(v => document.getElementById('view-'+v).style.display = (v==t?'block':'none'));
        hTitle.innerText = t=='chats'?'–ß–∞—Ç—ã':(t=='search'?'–ü–æ–∏—Å–∫':'–ü—Ä–æ—Ñ–∏–ª—å');
        if(t=='chats') this.renderChats();
    },

    renderChats() {
        const v = document.getElementById('view-chats'); v.innerHTML = "";
        Object.keys(DB.store.chats).forEach(id => {
            if(id.includes(DB.me)) {
                const partner = id.split('::').find(x => x != DB.me) || DB.me;
                const last = DB.store.chats[id].slice(-1)[0];
                v.innerHTML += `
                    <div class="list-item" onclick="UI.openChat('${partner}')">
                        <div class="avatar">${partner[0].toUpperCase()}</div>
                        <div style="flex:1">
                            <div style="font-weight:bold">${partner==DB.me?'‚≠ê –ò–∑–±—Ä–∞–Ω–Ω–æ–µ':partner}</div>
                            <div style="color:var(--text-dim); font-size:14px">${last.t}</div>
                        </div>
                    </div>`;
            }
        });
    },

    // –ü–æ–∏—Å–∫
    search() {
        const q = sIn.value.trim().toLowerCase();
        const res = document.getElementById('sRes'); res.innerHTML = "";
        if(!q) return;
        Object.keys(DB.store.users).forEach(u => {
            if(u.toLowerCase().includes(q) && u != DB.me) {
                res.innerHTML += `<div class="list-item" onclick="UI.openChat('${u}')"><div class="avatar">${u[0]}</div>${u}</div>`;
            }
        });
    },

    // –ß–∞—Ç
    activePartner: null,
    openChat(u) {
        this.activePartner = u;
        cName.innerText = u==DB.me?'–ò–∑–±—Ä–∞–Ω–Ω–æ–µ':u;
        scr_chat.classList.add('active');
        this.renderMsg();
    },
    closeChat() { scr_chat.classList.remove('active'); this.renderChats(); },
    renderMsg() {
        const list = document.getElementById('mList'); list.innerHTML = "";
        const cid = DB.cid(DB.me, this.activePartner);
        (DB.store.chats[cid] || []).forEach(m => {
            list.innerHTML += `<div class="bubble ${m.f==DB.me?'me':'other'}">${m.t}</div>`;
        });
        list.scrollTop = list.scrollHeight;
    },
    send() {
        const t = mIn.value.trim(); if(!t) return;
        const cid = DB.cid(DB.me, this.activePartner);
        if(!DB.store.chats[cid]) DB.store.chats[cid] = [];
        DB.store.chats[cid].push({f:DB.me, t:t});
        DB.save(); mIn.value = ""; this.renderMsg();
    },

    // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è
    copyID() {
        const code = btoa(JSON.stringify({u: DB.me}));
        prompt("–¢–≤–æ–π ID (–æ—Ç–ø—Ä–∞–≤—å –¥—Ä—É–≥—É):", code);
    },
    addID() {
        const code = prompt("–í—Å—Ç–∞–≤—å ID –¥—Ä—É–≥–∞ —Å—é–¥–∞:");
        if(code) {
            try {
                const data = JSON.parse(atob(code));
                if(!DB.store.users[data.u]) {
                    DB.store.users[data.u] = { pass: 'EXT' };
                    DB.save();
                    alert("–ì–æ—Ç–æ–≤–æ! –¢–µ–ø–µ—Ä—å –Ω–∞–π–¥–∏ –µ–≥–æ –≤ –ø–æ–∏—Å–∫–µ.");
                }
            } catch(e) { alert("–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥"); }
        }
    }
};

// –ê–í–¢–û-–í–•–û–î
window.onload = () => {
    const session = localStorage.getItem('dex_active_session');
    if(session && DB.store.users[session]) {
        UI.login(session);
    } else {
        scr_auth.classList.add('active');
    }
};
</script>
</body>
</html>

