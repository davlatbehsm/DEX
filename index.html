<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>DEX 5.0 Realism</title>
<style>
/* --- –î–ò–ó–ê–ô–ù –°–ò–°–¢–ï–ú–´ --- */
:root {
    --bg: #0f1621;
    --card: #17212b;
    --primary: #5288c1;
    --text: #ffffff;
    --text-dim: #7f91a4;
    --msg-out: #2b5278;
    --msg-in: #182533;
    --red: #ff595a;
    --green: #4caf50;
}

* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
body { margin: 0; background: #000; color: var(--text); font-family: -apple-system, Roboto, sans-serif; height: 100dvh; overflow: hidden; }

.app { width: 100%; height: 100%; max-width: 500px; margin: 0 auto; background: var(--bg); display: flex; flex-direction: column; position: relative; }

/* --- –≠–ö–†–ê–ù–´ --- */
.screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); display: none; flex-direction: column; z-index: 10; }
.screen.active { display: flex; animation: fadeIn 0.2s ease-out; }
@keyframes fadeIn { from { opacity: 0; transform: scale(0.99); } to { opacity: 1; transform: scale(1); } }

/* --- –•–ï–î–ï–†–´ --- */
header { height: 56px; background: var(--card); display: flex; align-items: center; padding: 0 16px; justify-content: space-between; box-shadow: 0 1px 3px rgba(0,0,0,0.3); z-index: 20; }
.title { font-weight: 700; font-size: 20px; }
.btn-icon { font-size: 24px; padding: 5px; cursor: pointer; }

/* --- –°–ü–ò–°–ö–ò (–ß–ê–¢–´/–ü–û–ò–°–ö) --- */
.content { flex: 1; overflow-y: auto; padding-bottom: 80px; }
.list-item { display: flex; align-items: center; padding: 12px 16px; border-bottom: 1px solid rgba(255,255,255,0.05); cursor: pointer; transition: 0.2s; }
.list-item:active { background: rgba(255,255,255,0.05); }

.avatar { 
    width: 50px; height: 50px; border-radius: 50%; background: var(--primary); 
    display: flex; align-items: center; justify-content: center; font-size: 20px; font-weight: bold; 
    margin-right: 14px; flex-shrink: 0; background-size: cover; background-position: center;
}
.saved-av { background: linear-gradient(135deg, #2b5278, #5288c1); }

.info { flex: 1; min-width: 0; }
.top-row { display: flex; justify-content: space-between; margin-bottom: 4px; }
.name { font-weight: 600; font-size: 16px; }
.meta { font-size: 12px; color: var(--text-dim); }
.preview { font-size: 14px; color: var(--text-dim); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

/* --- –ß–ê–¢ --- */
.chat-bg { background-image: url("https://web.telegram.org/img/bg_0.png"); background-blend-mode: overlay; background-color: var(--bg); }
.bubble { 
    max-width: 75%; padding: 8px 12px; border-radius: 12px; margin-bottom: 6px; 
    font-size: 15px; position: relative; word-wrap: break-word; 
}
.me { background: var(--msg-out); align-self: flex-end; border-bottom-right-radius: 2px; margin-left: auto; }
.other { background: var(--msg-in); align-self: flex-start; border-bottom-left-radius: 2px; }
.bubble img { max-width: 100%; border-radius: 8px; display: block; margin-bottom: 5px; }

.msg-stat { display: flex; justify-content: flex-end; align-items: center; gap: 3px; margin-top: 2px; }
.time { font-size: 11px; color: rgba(255,255,255,0.5); }
.tick { font-size: 10px; color: var(--primary); }

.input-bar { background: var(--card); padding: 8px; display: flex; align-items: flex-end; gap: 10px; padding-bottom: max(10px, env(safe-area-inset-bottom)); }
.field { flex: 1; background: #00000040; border: none; border-radius: 20px; color: #fff; padding: 10px 15px; resize: none; outline: none; max-height: 100px; font-size: 16px; }
.send-circle { width: 40px; height: 40px; background: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 18px; cursor: pointer; flex-shrink: 0; }

/* --- –¢–ê–ë –ë–ê–† --- */
.tab-bar { 
    height: 60px; background: var(--card); display: flex; justify-content: space-around; 
    align-items: center; padding-bottom: env(safe-area-inset-bottom); border-top: 1px solid #000; z-index: 20;
}
.tab { flex: 1; display: flex; flex-direction: column; align-items: center; font-size: 10px; color: var(--text-dim); padding: 5px; cursor: pointer; }
.tab.active { color: var(--primary); }
.tab-icon { font-size: 22px; margin-bottom: 3px; }

/* --- –§–û–†–ú–´ (–í–•–û–î / –ü–†–û–§–ò–õ–¨) --- */
.form-center { padding: 40px; display: flex; flex-direction: column; justify-content: center; height: 100%; gap: 15px; text-align: center; }
input { background: var(--card); border: 1px solid #2f3b47; color: white; padding: 14px; border-radius: 10px; width: 100%; font-size: 16px; outline: none; }
.btn { background: var(--primary); color: white; border: none; padding: 14px; border-radius: 10px; font-weight: bold; font-size: 16px; width: 100%; cursor: pointer; }
.btn-red { background: var(--red); margin-top: 10px; }
.label { text-align: left; color: var(--text-dim); font-size: 13px; margin-left: 5px; margin-bottom: -10px; margin-top: 10px; }

</style>
</head>
<body>

<div class="app">

    <div id="scr-auth" class="screen active">
        <div class="form-center">
            <h1 style="color:var(--primary); font-size:36px; margin-bottom:0;">DEX</h1>
            <p style="color:var(--text-dim); margin-top:0;">Secure Messenger</p>
            <input id="loginNick" placeholder="–ü—Ä–∏–¥—É–º–∞–π—Ç–µ Username">
            <button class="btn" onclick="Core.login()">–í–æ–π—Ç–∏</button>
            <p style="font-size:12px; color: #555;">–ï—Å–ª–∏ –∞–∫–∫–∞—É–Ω—Ç–∞ –Ω–µ—Ç, –æ–Ω –±—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω.</p>
        </div>
    </div>

    <div id="scr-main" class="screen">
        <header>
            <div class="title" id="headerTitle">–ß–∞—Ç—ã</div>
        </header>

        <div id="view-chats" class="content"></div>

        <div id="view-search" class="content" style="display:none; padding: 10px;">
            <input id="searchInput" placeholder="–ü–æ–∏—Å–∫ –ø–æ Username..." oninput="Core.search()">
            <div id="searchRes" style="margin-top: 15px;"></div>
        </div>

        <div id="view-profile" class="content" style="display:none;">
            <div class="form-center" style="justify-content: flex-start; padding-top: 20px;">
                <div id="myAv" class="avatar" style="width:100px; height:100px; font-size:40px; margin:0 auto;"></div>
                <h2 id="myName">User</h2>
                
                <div class="label">–û —Å–µ–±–µ (Bio)</div>
                <input id="profBio" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ –ø–∞—Ä—É —Å–ª–æ–≤...">
                
                <div class="label">–°—Å—ã–ª–∫–∞ –Ω–∞ –∞–≤–∞—Ç–∞—Ä–∫—É</div>
                <input id="profUrl" placeholder="https://...">

                <button class="btn" onclick="Core.saveProfile()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</button>
                <button class="btn" style="background:#333; margin-top:20px;" onclick="Core.logout()">–í—ã–π—Ç–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞</button>
                <button class="btn btn-red" onclick="Core.hardReset()">üóë –°–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ</button>
            </div>
        </div>

        <div class="tab-bar">
            <div class="tab active" onclick="Tabs.switch('chats', this)"><div class="tab-icon">üí¨</div>–ß–∞—Ç—ã</div>
            <div class="tab" onclick="Tabs.switch('search', this)"><div class="tab-icon">üîç</div>–ü–æ–∏—Å–∫</div>
            <div class="tab" onclick="Tabs.switch('profile', this)"><div class="tab-icon">üë§</div>–ü—Ä–æ—Ñ–∏–ª—å</div>
        </div>
    </div>

    <div id="scr-chat" class="screen">
        <header>
            <div style="display:flex; align-items:center; gap:10px;">
                <div class="btn-icon" onclick="Chat.close()">‚Üê</div>
                <div id="chatAv" class="avatar" style="width:36px; height:36px; font-size:14px; margin:0;"></div>
                <div>
                    <div id="chatName" style="font-weight:600;">Name</div>
                    <div style="font-size:11px; color:var(--primary);">–≤ —Å–µ—Ç–∏</div>
                </div>
            </div>
        </header>
        <div class="content chat-bg" id="msgList"></div>
        <div class="input-bar">
            <div class="btn-icon" style="color:var(--text-dim);" onclick="document.getElementById('fileIn').click()">üìé</div>
            <input type="file" id="fileIn" hidden accept="image/*" onchange="Chat.sendFile()">
            <textarea id="msgText" class="field" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." rows="1"></textarea>
            <div class="send-circle" onclick="Chat.send()">‚û§</div>
        </div>
    </div>

</div>

<script>
// --- –ë–ê–ó–ê –î–ê–ù–ù–´–• ---
const DB = {
    user: null,
    data: JSON.parse(localStorage.getItem('dex_db_v5')) || { users: {}, chats: {} },
    save() { localStorage.setItem('dex_db_v5', JSON.stringify(this.data)); },
    getChatId(u1, u2) { return [u1, u2].sort().join('::'); }
};

// --- –Ø–î–†–û –°–ò–°–¢–ï–ú–´ ---
const Core = {
    login() {
        const u = document.getElementById('loginNick').value.trim();
        if(!u) return alert("–í–≤–µ–¥–∏—Ç–µ Username");
        
        DB.user = u;
        
        // –ï—Å–ª–∏ —é–∑–µ—Ä–∞ –Ω–µ—Ç - —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º
        if(!DB.data.users[u]) {
            DB.data.users[u] = { bio: "Hi! I am using DEX.", avatar: "" };
            
            // –ê–í–¢–û-–°–û–ó–î–ê–ù–ò–ï "–ò–ó–ë–†–ê–ù–ù–û–ì–û" (Saved Messages)
            const selfId = DB.getChatId(u, u);
            DB.data.chats[selfId] = [{
                from: "System", type: "text", 
                text: "üëã –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –ò–∑–±—Ä–∞–Ω–Ω–æ–µ! –•—Ä–∞–Ω–∏ –∑–¥–µ—Å—å —Å–≤–æ–∏ –∑–∞–º–µ—Ç–∫–∏ –∏ —Ñ–∞–π–ª—ã.",
                time: new Date().toLocaleTimeString().slice(0,5)
            }];
            DB.save();
        }

        document.getElementById('scr-auth').classList.remove('active');
        document.getElementById('scr-main').classList.add('active');
        
        this.loadProfile();
        ChatList.render();
    },

    logout() {
        location.reload();
    },

    hardReset() {
        if(confirm("–£–¥–∞–ª–∏—Ç—å –í–°–ï –ø–µ—Ä–µ–ø–∏—Å–∫–∏ –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å —ç—Ç–æ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞?")) {
            localStorage.removeItem('dex_db_v5');
            location.reload();
        }
    },

    // –ü–æ–∏—Å–∫ —Ç–æ–ª—å–∫–æ –†–ï–ê–õ–¨–ù–´–• –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    search() {
        const q = document.getElementById('searchInput').value.trim().toLowerCase();
        const box = document.getElementById('searchRes');
        box.innerHTML = "";
        
        if(!q) return;

        const allUsers = Object.keys(DB.data.users);
        const found = allUsers.filter(u => u.toLowerCase().includes(q) && u !== DB.user);

        if(found.length === 0) {
            box.innerHTML = `<div style="text-align:center; color:gray; margin-top:20px;">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω.<br><small>–ò—â–∏—Ç–µ —Ç–µ—Ö, –∫—Ç–æ —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –Ω–∞ —ç—Ç–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ.</small></div>`;
            return;
        }

        found.forEach(u => {
            const div = document.createElement('div');
            div.className = 'list-item';
            div.onclick = () => Chat.open(u);
            div.innerHTML = `
                <div class="avatar">${u[0].toUpperCase()}</div>
                <div class="info">
                    <div class="name">${u}</div>
                    <div class="meta">${DB.data.users[u].bio || ""}</div>
                </div>
            `;
            box.appendChild(div);
        });
    },

    loadProfile() {
        const u = DB.data.users[DB.user];
        document.getElementById('myName').innerText = DB.user;
        document.getElementById('profBio').value = u.bio || "";
        document.getElementById('profUrl').value = u.avatar || "";
        this.renderAv(document.getElementById('myAv'), DB.user);
    },

    saveProfile() {
        const bio = document.getElementById('profBio').value;
        const ava = document.getElementById('profUrl').value;
        DB.data.users[DB.user].bio = bio;
        DB.data.users[DB.user].avatar = ava;
        DB.save();
        alert("–ü—Ä–æ—Ñ–∏–ª—å –æ–±–Ω–æ–≤–ª–µ–Ω!");
        this.renderAv(document.getElementById('myAv'), DB.user);
    },

    renderAv(el, name) {
        const u = DB.data.users[name];
        el.innerText = name[0].toUpperCase();
        el.style.backgroundImage = 'none';
        if(u && u.avatar) {
            el.innerText = "";
            el.style.backgroundImage = `url('${u.avatar}')`;
        }
        if(name === DB.user && el.id !== 'myAv') { // –ò–∫–æ–Ω–∫–∞ –¥–ª—è –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ
             el.innerText = "‚≠ê"; 
             el.style.background = "#e6a23c";
             el.style.backgroundImage = 'none';
        }
    }
};

// --- –°–ü–ò–°–û–ö –ß–ê–¢–û–í ---
const ChatList = {
    render() {
        const list = document.getElementById('view-chats');
        list.innerHTML = "";
        
        // 1. –°–Ω–∞—á–∞–ª–∞ —Ä–µ–Ω–¥–µ—Ä–∏–º –ò–∑–±—Ä–∞–Ω–Ω–æ–µ (Saved Messages)
        this.addItem(list, DB.user, "–ò–∑–±—Ä–∞–Ω–Ω–æ–µ (Saved Messages)");

        // 2. –†–µ–Ω–¥–µ—Ä–∏–º –æ—Å—Ç–∞–ª—å–Ω—ã–µ —á–∞—Ç—ã
        Object.keys(DB.data.chats).forEach(cid => {
            if(cid.includes(DB.user)) {
                const parts = cid.split('::');
                const partner = parts[0] === DB.user ? parts[1] : parts[0];
                if(partner !== DB.user) { // –ß—Ç–æ–±—ã –Ω–µ –¥—É–±–ª–∏—Ä–æ–≤–∞—Ç—å –∏–∑–±—Ä–∞–Ω–Ω–æ–µ
                    this.addItem(list, partner, partner);
                }
            }
        });
    },

    addItem(container, id, displayName) {
        const cid = DB.getChatId(DB.user, id);
        const msgs = DB.data.chats[cid] || [];
        const last = msgs[msgs.length-1] || {text:"", time:""};
        
        const div = document.createElement('div');
        div.className = 'list-item';
        div.onclick = () => Chat.open(id);
        
        let txt = last.type === 'img' ? 'üì∑ –§–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è' : last.text;
        
        div.innerHTML = `
            <div class="avatar" id="avList_${id}"></div>
            <div class="info">
                <div class="top-row">
                    <span class="name">${displayName}</span>
                    <span class="meta">${last.time}</span>
                </div>
                <div class="preview">${txt}</div>
            </div>
        `;
        container.appendChild(div);
        Core.renderAv(div.querySelector('.avatar'), id);
    }
};

// --- –ß–ê–¢ ---
const Chat = {
    active: null,
    
    open(partner) {
        this.active = partner;
        const cid = DB.getChatId(DB.user, partner);
        
        // UI
        const isSelf = partner === DB.user;
        document.getElementById('chatName').innerText = isSelf ? "–ò–∑–±—Ä–∞–Ω–Ω–æ–µ" : partner;
        Core.renderAv(document.getElementById('chatAv'), partner);
        
        document.getElementById('scr-chat').classList.add('active');
        this.renderMsg();
    },

    close() {
        document.getElementById('scr-chat').classList.remove('active');
        ChatList.render();
    },

    renderMsg() {
        const cid = DB.getChatId(DB.user, this.active);
        const box = document.getElementById('msgList');
        box.innerHTML = "";
        const msgs = DB.data.chats[cid] || [];

        msgs.forEach(m => {
            const div = document.createElement('div');
            const isMe = m.from === DB.user;
            div.className = `bubble ${isMe ? 'me' : 'other'}`;
            
            let content = m.type === 'img' ? `<img src="${m.text}">` : m.text;
            
            // –õ–æ–≥–∏–∫–∞ –≥–∞–ª–æ—á–µ–∫: 
            // –ï—Å–ª–∏ —ç—Ç–æ –ò–∑–±—Ä–∞–Ω–Ω–æ–µ (—Å–∞–º —Å–µ–±–µ) -> –≤—Å–µ–≥–¥–∞ –¥–≤–µ –≥–∞–ª–æ—á–∫–∏.
            // –ï—Å–ª–∏ –¥—Ä—É–≥–æ–º—É -> –æ–¥–Ω–∞ –≥–∞–ª–æ—á–∫–∞ (—Ç–∏–ø–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ).
            let ticks = "";
            if(isMe) {
                ticks = (this.active === DB.user) ? "‚úì‚úì" : "‚úì"; 
            }

            div.innerHTML = `
                ${content}
                <div class="msg-stat">
                    <span class="time">${m.time}</span>
                    <span class="tick">${ticks}</span>
                </div>
            `;
            box.appendChild(div);
        });
        box.scrollTop = box.scrollHeight;
    },

    send() {
        const txt = document.getElementById('msgText').value.trim();
        if(!txt) return;
        this.push(txt, 'text');
        document.getElementById('msgText').value = "";
    },

    sendFile() {
        const f = document.getElementById('fileIn').files[0];
        if(!f) return;
        const reader = new FileReader();
        reader.onload = (e) => this.push(e.target.result, 'img');
        reader.readAsDataURL(f);
    },

    push(content, type) {
        const cid = DB.getChatId(DB.user, this.active);
        if(!DB.data.chats[cid]) DB.data.chats[cid] = [];
        
        DB.data.chats[cid].push({
            from: DB.user,
            text: content,
            type: type,
            time: new Date().toLocaleTimeString().slice(0,5)
        });
        DB.save();
        this.renderMsg();
    }
};

// --- –¢–ê–ë–´ ---
const Tabs = {
    switch(name, el) {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        el.classList.add('active');
        document.querySelectorAll('.content').forEach(c => c.style.display = 'none');
        document.getElementById('view-'+name).style.display = 'block';
        
        if(name === 'chats') ChatList.render();
        if(name === 'profile') Core.loadProfile();
        
        document.getElementById('headerTitle').innerText = 
            name === 'chats' ? '–ß–∞—Ç—ã' : (name === 'search' ? '–ü–æ–∏—Å–∫' : '–ü—Ä–æ—Ñ–∏–ª—å');
    }
};

// INIT
if(localStorage.getItem('dex_db_v5')) {
    // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –∞–≤—Ç–æ-–ª–æ–≥–∏–Ω, –Ω–æ –¥–ª—è —Ç–µ—Å—Ç–∞ –ª—É—á—à–µ –≤–∏–¥–µ—Ç—å —ç–∫—Ä–∞–Ω –≤—Ö–æ–¥–∞
}
</script>
</body>
</html>
