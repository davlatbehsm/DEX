<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DEX</title>

<style>
*{box-sizing:border-box}
body{
  margin:0;
  font-family:system-ui,Roboto,Arial;
  background:#0e1621;
  color:#fff;
}
.app{
  max-width:420px;
  margin:auto;
  min-height:100vh;
  background:#0e1621;
}
header{
  text-align:center;
  padding:14px;
  font-size:22px;
  font-weight:600;
  background:#17212b;
}

.screen{display:none}
.screen.active{display:block}

input,button{
  width:100%;
  padding:12px;
  margin-top:10px;
  border-radius:12px;
  border:none;
  font-size:15px;
}
input{background:#1f2933;color:#fff}
button{background:#2aabee;color:#fff}

.link{
  margin-top:14px;
  text-align:center;
  color:#2aabee;
  cursor:pointer;
}

/* ===== Chats list ===== */
.search{
  background:#1f2933;
  padding:10px;
  border-radius:12px;
  margin:12px;
}
.chat{
  display:flex;
  gap:12px;
  padding:12px;
  cursor:pointer;
}
.chat:hover{background:#1f2933}
.avatar{
  width:46px;height:46px;
  border-radius:50%;
  background:#2aabee;
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:700;
}
.chat-info{flex:1}
.chat-name{font-weight:600}
.chat-last{font-size:13px;color:#9ca3af}

/* ===== Messages ===== */
.messages{
  height:65vh;
  overflow-y:auto;
  padding:12px;
}
.msg{
  max-width:75%;
  padding:8px 12px;
  border-radius:14px;
  margin-bottom:8px;
}
.me{background:#2aabee;margin-left:auto}
.other{background:#1f2933}

.input-bar{
  display:flex;
  gap:6px;
  padding:10px;
}
.hidden{display:none}
</style>
</head>

<body>

<div class="app">

<header>DEX</header>

<!-- REGISTER -->
<div id="register" class="screen active" style="padding:16px">
  <input id="regUser" placeholder="Username">
  <input id="regPass" type="password" placeholder="–ü–∞—Ä–æ–ª—å">
  <button id="regBtn">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
</div>

<!-- CHAT LIST -->
<div id="chatListScreen" class="screen">
  <input id="search" class="search" placeholder="–ü–æ–∏—Å–∫ —á–∞—Ç–æ–≤">
  <div id="chatList"></div>
</div>

<!-- CHAT -->
<div id="chatScreen" class="screen">
  <div class="messages" id="messages"></div>
  <div class="input-bar">
    <input type="file" id="imgInput" hidden accept="image/*">
    <button id="imgBtn">üìé</button>
    <input id="msgText" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ">
    <button id="sendBtn">‚û§</button>
  </div>
</div>

</div>

<script>
// ===== STATE =====
const users = JSON.parse(localStorage.getItem("dex_users")||"{}");
const chats = JSON.parse(localStorage.getItem("dex_chats")||"{}");
let currentUser = localStorage.getItem("dex_current");
let activeChat = null;

// ===== SCREENS =====
const registerScreen = register;
const chatListScreen = document.getElementById("chatListScreen");
const chatScreen = document.getElementById("chatScreen");

function show(screen){
  [registerScreen,chatListScreen,chatScreen].forEach(s=>s.classList.remove("active"));
  screen.classList.add("active");
}

// ===== REGISTER (AUTO LOGIN) =====
regBtn.onclick = () => {
  const u = regUser.value.trim();
  const p = regPass.value.trim();
  if(!u || !p) return alert("–ó–∞–ø–æ–ª–Ω–∏ –ø–æ–ª—è");
  if(users[u]) return alert("Username –∑–∞–Ω—è—Ç");

  users[u] = {pass:p};
  localStorage.setItem("dex_users", JSON.stringify(users));

  currentUser = u;
  localStorage.setItem("dex_current", u);

  // –°–æ–∑–¥–∞—ë–º —á–∞—Ç —Å —Å–æ–±–æ–π (Saved Messages)
  chats[u] = chats[u] || [
    {from:u, text:"–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ DEX üëã"}
  ];
  localStorage.setItem("dex_chats", JSON.stringify(chats));

  renderChats();
  show(chatListScreen);
};

// ===== CHATS LIST =====
function renderChats(){
  chatList.innerHTML="";
  Object.keys(chats)
    .filter(c=>c.includes(search.value))
    .forEach(c=>{
      const last = chats[c].slice(-1)[0];
      chatList.innerHTML += `
        <div class="chat" onclick="openChat('${c}')">
          <div class="avatar">${c[0].toUpperCase()}</div>
          <div class="chat-info">
            <div class="chat-name">${c === currentUser ? "Saved Messages" : c}</div>
            <div class="chat-last">${last?.text || ""}</div>
          </div>
        </div>
      `;
    });
}
search.oninput = renderChats;

function openChat(u){
  activeChat = u;
  renderMessages();
  show(chatScreen);
}

// ===== MESSAGES =====
function renderMessages(){
  messages.innerHTML="";
  chats[activeChat].forEach(m=>{
    messages.innerHTML += `
      <div class="msg ${m.from===currentUser?'me':'other'}">${m.text}</div>
    `;
  });
  messages.scrollTop = messages.scrollHeight;
}

sendBtn.onclick = () => {
  if(!msgText.value) return;
  chats[activeChat].push({from:currentUser,text:msgText.value});
  msgText.value="";
  save();
};

function save(){
  localStorage.setItem("dex_chats", JSON.stringify(chats));
  renderMessages();
  renderChats();
}

// ===== AUTO LOGIN =====
if(currentUser){
  renderChats();
  show(chatListScreen);
}
</script>

</body>
</html>
