<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>DEX 7.0 - Fixed</title>
<style>
:root {
    --bg: #0f1621; --card: #17212b; --primary: #5288c1; --text: #ffffff;
    --text-dim: #7f91a4; --msg-out: #2b5278; --msg-in: #182533; --red: #ff595a;
}
* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
body { margin: 0; background: #000; color: var(--text); font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto; height: 100dvh; overflow: hidden; }
.app { width: 100%; height: 100%; max-width: 500px; margin: 0 auto; background: var(--bg); display: flex; flex-direction: column; position: relative; }

/* –≠–ö–†–ê–ù–´ */
.screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); display: none; flex-direction: column; z-index: 10; }
.screen.active { display: flex; }

header { height: 60px; background: var(--card); display: flex; align-items: center; padding: 0 16px; justify-content: space-between; z-index: 20; box-shadow: 0 2px 8px rgba(0,0,0,0.4); }
.content { flex: 1; overflow-y: auto; padding-bottom: 80px; }

/* –¢–ê–ë –ë–ê–† */
.tab-bar { height: 65px; background: var(--card); display: flex; border-top: 1px solid #000; padding-bottom: env(safe-area-inset-bottom); }
.tab { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 11px; color: var(--text-dim); cursor: pointer; }
.tab.active { color: var(--primary); }

/* –≠–õ–ï–ú–ï–ù–¢–´ –°–ü–ò–°–ö–ê */
.list-item { display: flex; align-items: center; padding: 12px 16px; border-bottom: 1px solid #1c252f; cursor: pointer; }
.avatar { width: 50px; height: 50px; border-radius: 50%; background: var(--primary); display: flex; align-items: center; justify-content: center; font-size: 20px; font-weight: bold; margin-right: 15px; }

/* –°–û–û–ë–©–ï–ù–ò–Ø */
.bubble { max-width: 80%; padding: 10px 14px; border-radius: 16px; margin-bottom: 8px; font-size: 15px; }
.me { background: var(--msg-out); align-self: flex-end; border-bottom-right-radius: 4px; margin-left: auto; }
.other { background: var(--msg-in); align-self: flex-start; border-bottom-left-radius: 4px; }

/* –í–•–û–î */
.auth-box { padding: 30px; display: flex; flex-direction: column; gap: 15px; height: 100%; justify-content: center; }
input { background: var(--card); border: 1px solid #2f3b47; color: #fff; padding: 15px; border-radius: 12px; font-size: 16px; width: 100%; }
.btn { background: var(--primary); color: #fff; border: none; padding: 15px; border-radius: 12px; font-weight: bold; cursor: pointer; width: 100%; }
</style>
</head>
<body>

<div class="app">
    <div id="scr-auth" class="screen">
        <div class="auth-box">
            <h1 style="text-align:center; color:var(--primary); font-size:40px; margin:0">DEX</h1>
            <p style="text-align:center; color:var(--text-dim)">–í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É</p>
            <input id="loginUser" placeholder="Username">
            <input id="loginPass" type="password" placeholder="Password">
            <button class="btn" onclick="Auth.process()">–ù–∞—á–∞—Ç—å –æ–±—â–µ–Ω–∏–µ</button>
        </div>
    </div>

    <div id="scr-main" class="screen">
        <header><div style="font-weight:bold; font-size:20px" id="titleText">–ß–∞—Ç—ã</div></header>
        <div id="view-chats" class="content"></div>
        <div id="view-search" class="content" style="display:none; padding:15px">
            <input id="searchIn" placeholder="–ü–æ–∏—Å–∫ –ø–æ –±–∞–∑–µ..." oninput="Search.run()">
            <div id="searchRes" style="margin-top:10px"></div>
        </div>
        <div id="view-prof" class="content" style="display:none; padding:20px; text-align:center">
            <div id="myAv" class="avatar" style="width:80px; height:80px; margin:0 auto 15px; font-size:30px"></div>
            <h2 id="myNameDisplay">User</h2>
            <button class="btn" style="background:#242f3d" onclick="Sync.copyID()">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –º–æ–π ID</button>
            <button class="btn" style="background:#242f3d; margin-top:10px" onclick="Sync.importFriend()">–î–æ–±–∞–≤–∏—Ç—å –¥—Ä—É–≥–∞ –ø–æ ID</button>
            <button class="btn" style="background:var(--red); margin-top:20px" onclick="Auth.logout()">–í—ã–π—Ç–∏</button>
        </div>
        <div class="tab-bar">
            <div class="tab active" onclick="Tabs.set('chats', this)"><span>üí¨</span>–ß–∞—Ç—ã</div>
            <div class="tab" onclick="Tabs.set('search', this)"><span>üîç</span>–ü–æ–∏—Å–∫</div>
            <div class="tab" onclick="Tabs.set('prof', this)"><span>üë§</span>–ü—Ä–æ—Ñ–∏–ª—å</div>
        </div>
    </div>

    <div id="scr-chat" class="screen">
        <header>
            <div style="display:flex; align-items:center; gap:12px">
                <div onclick="Chat.close()" style="cursor:pointer; font-size:24px">‚Üê</div>
                <div id="chatName" style="font-weight:bold">Name</div>
            </div>
        </header>
        <div id="msgList" class="content" style="padding:15px; display:flex; flex-direction:column"></div>
        <div style="padding:10px; background:var(--card); display:flex; gap:10px">
            <input id="msgIn" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." style="margin:0">
            <button onclick="Chat.send()" style="background:var(--primary); border:none; color:#fff; width:45px; border-radius:12px">‚û§</button>
        </div>
    </div>
</div>

<script>
const DB = {
    me: null,
    data: JSON.parse(localStorage.getItem('dex_final')) || { users: {}, chats: {} },
    save() { localStorage.setItem('dex_final', JSON.stringify(this.data)); },
    cid(u1, u2) { return [u1, u2].sort().join('_vs_'); }
};

const Auth = {
    process() {
        const u = loginUser.value.trim(), p = loginPass.value.trim();
        if(!u || !p) return alert("–ó–∞–ø–æ–ª–Ω–∏ –ø–æ–ª—è!");

        if(!DB.data.users[u]) {
            DB.data.users[u] = { pass: p };
            DB.data.chats[DB.cid(u, u)] = [{f:'System', t:'–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –ò–∑–±—Ä–∞–Ω–Ω–æ–µ!', d:''}];
            DB.save();
        } else if(DB.data.users[u].pass !== p) {
            return alert("–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å!");
        }

        this.login(u);
    },
    login(u) {
        DB.me = u;
        localStorage.setItem('dex_session', u);
        scr_auth.classList.remove('active');
        scr_main.classList.add('active');
        myNameDisplay.innerText = u;
        myAv.innerText = u[0].toUpperCase();
        Tabs.set('chats', document.querySelector('.tab'));
    },
    logout() {
        localStorage.removeItem('dex_session');
        location.reload();
    }
};

const Tabs = {
    set(t, el) {
        document.querySelectorAll('.tab').forEach(x => x.classList.remove('active'));
        el.classList.add('active');
        ['chats', 'search', 'prof'].forEach(v => document.getElementById('view-'+v).style.display = (v==t?'block':'none'));
        titleText.innerText = t=='chats'?'–ß–∞—Ç—ã':(t=='search'?'–ü–æ–∏—Å–∫':'–ü—Ä–æ—Ñ–∏–ª—å');
        if(t=='chats') this.renderList();
    },
    renderList() {
        const v = document.getElementById('view-chats'); v.innerHTML = "";
        Object.keys(DB.data.chats).forEach(id => {
            if(id.includes(DB.me)) {
                const partner = id.split('_vs_').find(x => x != DB.me) || DB.me;
                const last = DB.data.chats[id].slice(-1)[0];
                v.innerHTML += `
                    <div class="list-item" onclick="Chat.open('${partner}')">
                        <div class="avatar">${partner[0].toUpperCase()}</div>
                        <div style="flex:1">
                            <div style="font-weight:bold">${partner==DB.me?'‚≠ê –ò–∑–±—Ä–∞–Ω–Ω–æ–µ':partner}</div>
                            <div style="color:var(--text-dim); font-size:14px">${last.t}</div>
                        </div>
                    </div>`;
            }
        });
    }
};

const Chat = {
    target: null,
    open(u) {
        this.target = u; chatName.innerText = u==DB.me?'–ò–∑–±—Ä–∞–Ω–Ω–æ–µ':u;
        scr_chat.classList.add('active'); this.render();
    },
    close() { scr_chat.classList.remove('active'); Tabs.renderList(); },
    render() {
        const list = document.getElementById('msgList'); list.innerHTML = "";
        const cid = DB.cid(DB.me, this.target);
        (DB.data.chats[cid] || []).forEach(m => {
            list.innerHTML += `<div class="bubble ${m.f==DB.me?'me':'other'}">${m.t}</div>`;
        });
        list.scrollTop = list.scrollHeight;
    },
    send() {
        const t = msgIn.value.trim(); if(!t) return;
        const cid = DB.cid(DB.me, this.target);
        if(!DB.data.chats[cid]) DB.data.chats[cid] = [];
        DB.data.chats[cid].push({f:DB.me, t:t});
        DB.save(); msgIn.value = ""; this.render();
    }
};

const Search = {
    run() {
        const q = searchIn.value.trim().toLowerCase();
        const res = document.getElementById('searchRes'); res.innerHTML = "";
        if(!q) return;
        Object.keys(DB.data.users).forEach(u => {
            if(u.toLowerCase().includes(q) && u != DB.me) {
                res.innerHTML += `<div class="list-item" onclick="Chat.open('${u}')"><div class="avatar">${u[0]}</div>${u}</div>`;
            }
        });
    }
};

const Sync = {
    copyID() {
        const id = btoa(JSON.stringify({u: DB.me}));
        prompt("–¢–≤–æ–π ID (—Å–∫–∏–Ω—å –¥—Ä—É–≥—É):", id);
    },
    importFriend() {
        const code = prompt("–í—Å—Ç–∞–≤—å ID –¥—Ä—É–≥–∞:");
        if(code) {
            try {
                const data = JSON.parse(atob(code));
                if(!DB.data.users[data.u]) {
                    DB.data.users[data.u] = { pass: 'ext' };
                    DB.save();
                    alert("–î—Ä—É–≥ –¥–æ–±–∞–≤–ª–µ–Ω! –ò—â–∏ –µ–≥–æ –≤ –ü–æ–∏—Å–∫–µ.");
                }
            } catch(e) { alert("–û—à–∏–±–∫–∞ –∫–æ–¥–∞"); }
        }
    }
};

// AUTO-LOGIN
const savedUser = localStorage.getItem('dex_session');
if(savedUser && DB.data.users[savedUser]) {
    Auth.login(savedUser);
} else {
    scr_auth.classList.add('active');
}
</script>
</body>
</html>

