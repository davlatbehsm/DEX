<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DEX</title>

<style>
*{box-sizing:border-box}
body{
  margin:0;
  font-family:system-ui,Roboto,Arial;
  background:#0e1621;
  color:#fff;
}
.app{
  max-width:420px;
  margin:auto;
  min-height:100vh;
  background:#0e1621;
}
header{
  text-align:center;
  padding:16px;
  font-size:24px;
  font-weight:600;
  background:#17212b;
}
.screen{display:none;padding:16px}
.screen.active{display:block}

input,button{
  width:100%;
  padding:12px;
  margin-top:10px;
  border-radius:12px;
  border:none;
  font-size:15px;
}
input{background:#1f2933;color:#fff}
button{background:#2aabee;color:#fff}

.link{
  margin-top:14px;
  text-align:center;
  color:#2aabee;
  cursor:pointer;
}

/* chats */
.search{
  background:#1f2933;
  padding:10px;
  border-radius:12px;
  margin-bottom:10px;
}
.chat{
  display:flex;
  gap:12px;
  padding:10px;
  border-radius:12px;
  cursor:pointer;
}
.chat:hover{background:#1f2933}
.avatar{
  width:48px;height:48px;
  border-radius:50%;
  background:#2aabee;
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:700;
  overflow:hidden;
}
.avatar img{width:100%;height:100%;object-fit:cover}
.chat-info{flex:1}
.chat-name{font-weight:600}
.chat-last{font-size:13px;color:#9ca3af}
.star{color:#facc15}

/* messages */
.messages{
  height:65vh;
  overflow-y:auto;
  padding:10px;
}
.msg{
  max-width:75%;
  padding:8px 12px;
  border-radius:14px;
  margin-bottom:8px;
}
.me{background:#2aabee;margin-left:auto}
.other{background:#1f2933}
.msg img{max-width:100%;border-radius:10px}

.input-bar{
  display:flex;
  gap:6px;
  padding:10px;
}
.hidden{display:none}
</style>
</head>

<body>

<div class="app">
<header>DEX</header>

<!-- LOGIN -->
<div id="login" class="screen active">
  <input id="loginUser" placeholder="Username">
  <input id="loginPass" type="password" placeholder="–ü–∞—Ä–æ–ª—å">
  <button id="loginBtn">–í–æ–π—Ç–∏</button>
  <div class="link" id="toRegister">–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</div>
</div>

<!-- REGISTER -->
<div id="register" class="screen">
  <input id="regUser" placeholder="Username">
  <input id="regPass" type="password" placeholder="–ü–∞—Ä–æ–ª—å">
  <button id="regBtn">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
  <div class="link" id="toLogin">–£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç? –í–æ–π—Ç–∏</div>
</div>

<!-- CHAT LIST -->
<div id="chatListScreen" class="screen">
  <input id="search" class="search" placeholder="–ü–æ–∏—Å–∫">
  <div id="chatList"></div>
</div>

<!-- CHAT -->
<div id="chatScreen" class="screen">
  <div class="messages" id="messages"></div>
  <div class="input-bar">
    <input type="file" id="imgInput" hidden accept="image/*">
    <button id="imgBtn">üìé</button>
    <input id="msgText" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ">
    <button id="sendBtn">‚û§</button>
  </div>
</div>

</div>

<script>
// ====== STATE ======
const users = JSON.parse(localStorage.getItem("dex_users") || "{}");
const chats = JSON.parse(localStorage.getItem("dex_chats") || "{}");
const favorites = JSON.parse(localStorage.getItem("dex_fav") || "[]");
let currentUser = localStorage.getItem("dex_current");
let activeChat = null;

// ====== SCREENS ======
const loginScreen = document.getElementById("login");
const registerScreen = document.getElementById("register");
const chatListScreen = document.getElementById("chatListScreen");
const chatScreen = document.getElementById("chatScreen");

function show(screen){
  [loginScreen,registerScreen,chatListScreen,chatScreen]
    .forEach(s=>s.classList.remove("active"));
  screen.classList.add("active");
}

// ====== AUTH ======
document.getElementById("toRegister").onclick = () => show(registerScreen);
document.getElementById("toLogin").onclick = () => show(loginScreen);

document.getElementById("regBtn").onclick = () => {
  const u = regUser.value.trim();
  const p = regPass.value.trim();
  if(!u || !p) return alert("–ó–∞–ø–æ–ª–Ω–∏ –ø–æ–ª—è");
  if(users[u]) return alert("Username –∑–∞–Ω—è—Ç");
  users[u] = {pass:p, ava:null};
  localStorage.setItem("dex_users", JSON.stringify(users));
  alert("–ê–∫–∫–∞—É–Ω—Ç —Å–æ–∑–¥–∞–Ω");
  show(loginScreen);
};

document.getElementById("loginBtn").onclick = () => {
  const u = loginUser.value.trim();
  const p = loginPass.value.trim();
  if(!users[u] || users[u].pass !== p) return alert("–ù–µ–≤–µ—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ");
  currentUser = u;
  localStorage.setItem("dex_current", u);
  renderChats();
  show(chatListScreen);
};

// ====== CHATS ======
function renderChats(){
  chatList.innerHTML = "";
  const keys = Object.keys(chats).filter(k=>k.includes(search.value));
  keys.forEach(u=>{
    const last = chats[u].slice(-1)[0];
    chatList.innerHTML += `
      <div class="chat" onclick="openChat('${u}')">
        <div class="avatar">${u[0].toUpperCase()}</div>
        <div class="chat-info">
          <div class="chat-name">${u}</div>
          <div class="chat-last">${last?.text || ""}</div>
        </div>
      </div>`;
  });
}

search.oninput = renderChats;

function openChat(u){
  activeChat = u;
  if(!chats[u]) chats[u] = [];
  renderMessages();
  show(chatScreen);
}

// ====== MESSAGES ======
function renderMessages(){
  messages.innerHTML = "";
  chats[activeChat].forEach(m=>{
    messages.innerHTML += `
      <div class="msg ${m.from===currentUser?'me':'other'}">
        ${m.text || ""}
        ${m.img ? `<img src="${m.img}">` : ""}
      </div>`;
  });
}

document.getElementById("sendBtn").onclick = () => {
  if(!msgText.value) return;
  chats[activeChat].push({from:currentUser, text:msgText.value});
  msgText.value = "";
  save();
};

document.getElementById("imgBtn").onclick = () => imgInput.click();
imgInput.onchange = e => {
  const r = new FileReader();
  r.onload = () => {
    chats[activeChat].push({from:currentUser, img:r.result});
    save();
  };
  r.readAsDataURL(e.target.files[0]);
};

function save(){
  localStorage.setItem("dex_chats", JSON.stringify(chats));
  renderMessages();
  renderChats();
}

// ====== AUTO LOGIN ======
if(currentUser){
  renderChats();
  show(chatListScreen);
}
</script>

</body>
</html>
