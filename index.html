<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DEX Messenger</title>

<style>
:root{
--bg:#0f1621;--card:#17212b;--primary:#5288c1;
--text:#fff;--dim:#7f91a4;
--out:#2b5278;--in:#182533;
--radius:14px;
}

/* THEMES */
[data-theme="amoled"]{--bg:#000;--card:#000}
[data-theme="light"]{--bg:#f5f5f5;--card:#fff;--text:#000;--dim:#555}
[data-accent="green"]{--primary:#4caf50}
[data-accent="violet"]{--primary:#9c27b0}

*{box-sizing:border-box}
body{margin:0;font-family:-apple-system;background:#000}
.app{max-width:500px;margin:auto;height:100vh;background:var(--bg);color:var(--text);position:relative}

/* screens */
.screen{position:absolute;inset:0;display:none;flex-direction:column}
.screen.active{display:flex}

/* header */
header{height:56px;background:var(--card);display:flex;align-items:center;padding:0 14px}
.title{font-weight:700}

/* auth */
.center{flex:1;display:flex;flex-direction:column;justify-content:center;padding:30px;gap:14px;text-align:center}
input,select{padding:14px;border-radius:var(--radius);border:1px solid #333;background:var(--card);color:var(--text)}
button{padding:14px;border:none;border-radius:var(--radius);background:var(--primary);color:#fff;font-weight:700}

/* list */
.item{display:flex;gap:12px;padding:12px;border-bottom:1px solid #1c2733;cursor:pointer}
.avatar{width:46px;height:46px;border-radius:50%;background:var(--primary);
display:flex;align-items:center;justify-content:center;font-weight:700}
.preview{font-size:13px;color:var(--dim);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

/* chat */
.msgs{flex:1;padding:10px;display:flex;flex-direction:column;gap:6px}
.bubble{max-width:75%;padding:8px 12px;border-radius:var(--radius)}
.me{background:var(--out);align-self:flex-end}
.other{background:var(--in)}
.bubble img{max-width:100%;border-radius:10px}
.time{font-size:11px;color:#aaa;text-align:right}

/* input */
.input{display:flex;gap:8px;padding:10px;background:var(--card)}
.input input{flex:1}

/* tabs */
.tabs{height:56px;background:var(--card);display:flex}
.tab{flex:1;text-align:center;font-size:12px;color:var(--dim);padding:6px}
.tab.active{color:var(--primary)}
</style>
</head>

<body>
<div class="app" id="app">

<!-- AUTH -->
<div id="auth" class="screen active">
<div class="center">
<h1 style="color:var(--primary)">DEX</h1>
<input id="nick" placeholder="Username">
<button onclick="Core.login()">–í–æ–π—Ç–∏ / –°–æ–∑–¥–∞—Ç—å</button>
</div>
</div>

<!-- MAIN -->
<div id="main" class="screen">
<header><div class="title" id="title">–ß–∞—Ç—ã</div></header>

<div id="chats" class="content"></div>

<div id="search" class="content" style="display:none;padding:10px">
<input id="searchIn" placeholder="–ü–æ–∏—Å–∫..." oninput="Core.search()">
<div id="searchRes"></div>
</div>

<div id="profile" class="content" style="display:none;padding:20px">
<h3>üé® –û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ</h3>
<select onchange="Settings.theme(this.value)">
<option value="">Dark</option>
<option value="amoled">AMOLED</option>
<option value="light">Light</option>
</select>

<select onchange="Settings.accent(this.value)" style="margin-top:10px">
<option value="">Blue</option>
<option value="green">Green</option>
<option value="violet">Violet</option>
</select>

<button onclick="Core.logout()" style="background:#ff595a;margin-top:20px">–í—ã–π—Ç–∏</button>
</div>

<div class="tabs">
<div class="tab active" onclick="Tabs.go('chats',this)">üí¨<br>–ß–∞—Ç—ã</div>
<div class="tab" onclick="Tabs.go('search',this)">üîç<br>–ü–æ–∏—Å–∫</div>
<div class="tab" onclick="Tabs.go('profile',this)">üé®<br>–¢–µ–º–∞</div>
</div>
</div>

<!-- CHAT -->
<div id="chat" class="screen">
<header>
<div onclick="Chat.close()" style="margin-right:10px;cursor:pointer">‚Üê</div>
<div class="title" id="chatName"></div>
</header>

<div id="msgs" class="msgs"></div>

<div class="input">
<input type="file" id="file" hidden onchange="Chat.sendFile()">
<button onclick="file.click()">üìé</button>
<input id="msg">
<button onclick="Chat.send()">‚û§</button>
</div>
</div>

</div>

<script>
const DB={
user:localStorage.getItem('dex_user'),
data:JSON.parse(localStorage.getItem('dex_data'))||{users:{},chats:{}},
save(){localStorage.setItem('dex_data',JSON.stringify(this.data));if(this.user)localStorage.setItem('dex_user',this.user)},
cid(a,b){return[a,b].sort().join('::')}
}

const Core={
login(){
const u=nick.value.trim();if(!u)return
DB.user=u
if(!DB.data.users[u]){
DB.data.users[u]={}
DB.data.chats[DB.cid(u,u)]=[{from:u,text:'‚≠ê –ò–∑–±—Ä–∞–Ω–Ω–æ–µ',time:''}]
}
DB.save();UI.enter()
},
logout(){localStorage.clear();location.reload()},
search(){
searchRes.innerHTML=''
Object.keys(DB.data.users).forEach(u=>{
if(u!==DB.user && u.includes(searchIn.value))
searchRes.innerHTML+=`<div class="item" onclick="Chat.open('${u}')">
<div class="avatar">${u[0]}</div><div>${u}</div></div>`
})
}
}

const UI={
enter(){
auth.classList.remove('active')
main.classList.add('active')
ChatList.render()
Settings.load()
}
}

const ChatList={
render(){
chats.innerHTML=''
Object.keys(DB.data.chats).forEach(id=>{
if(id.includes(DB.user)){
const p=id.split('::').find(x=>x!==DB.user)||DB.user
const last=DB.data.chats[id].slice(-1)[0]
chats.innerHTML+=`<div class="item" onclick="Chat.open('${p}')">
<div class="avatar">${p===DB.user?'‚≠ê':p[0]}</div>
<div><b>${p===DB.user?'–ò–∑–±—Ä–∞–Ω–Ω–æ–µ':p}</b>
<div class="preview">${last.text}</div></div></div>`
}
})
}
}

const Chat={
with:null,
open(u){this.with=u;chatName.innerText=u===DB.user?'–ò–∑–±—Ä–∞–Ω–Ω–æ–µ':u;chat.classList.add('active');this.render()},
close(){chat.classList.remove('active');ChatList.render()},
render(){
msgs.innerHTML=''
(DB.data.chats[DB.cid(DB.user,this.with)]||[]).forEach(m=>{
msgs.innerHTML+=`<div class="bubble ${m.from===DB.user?'me':'other'}">
${m.text.startsWith('data:')?`<img src="${m.text}">`:m.text}
<div class="time">${m.time}</div></div>`
})
msgs.scrollTop=msgs.scrollHeight
},
send(){
if(!msg.value)return
this.push(msg.value);msg.value=''
},
sendFile(){
const r=new FileReader()
r.onload=e=>this.push(e.target.result)
r.readAsDataURL(file.files[0])
},
push(t){
const id=DB.cid(DB.user,this.with)
DB.data.chats[id].push({from:DB.user,text:t,time:new Date().toLocaleTimeString().slice(0,5)})
DB.save();this.render()
}
}

const Tabs={
go(n,el){
document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'))
el.classList.add('active')
;['chats','search','profile'].forEach(v=>document.getElementById(v).style.display=v===n?'block':'none')
}
}

const Settings={
load(){
app.dataset.theme=localStorage.getItem('theme')||''
app.dataset.accent=localStorage.getItem('accent')||''
},
theme(v){localStorage.setItem('theme',v);app.dataset.theme=v},
accent(v){localStorage.setItem('accent',v);app.dataset.accent=v}
}

if(DB.user&&DB.data.users[DB.user])UI.enter()
</script>
</body>
</html>
