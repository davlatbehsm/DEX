<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>DEX 3.0</title>
<style>
/* --- 1. –û–°–ù–û–í–ù–û–ô –î–ò–ó–ê–ô–ù --- */
:root {
    --bg: #0f1621;
    --surface: #17212b;
    --primary: #5288c1;
    --text-main: #f5f5f5;
    --text-sec: #7f91a4;
    --msg-in: #182533;
    --msg-out: #2b5278;
    --red: #e53935;
}

* { box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
body { margin: 0; background: #000; color: var(--text-main); height: 100vh; display: flex; justify-content: center; overflow: hidden; }

.app {
    width: 100%; max-width: 480px; height: 100%;
    background: var(--bg); display: flex; flex-direction: column;
    position: relative; box-shadow: 0 0 20px rgba(0,0,0,0.5);
}

/* --- 2. –≠–ö–†–ê–ù–´ --- */
.screen {
    display: none; flex-direction: column; height: 100%;
    position: absolute; top: 0; left: 0; width: 100%; background: var(--bg); z-index: 10;
}
.screen.active { display: flex; z-index: 20; }

/* --- 3. –•–ï–î–ï–† --- */
header {
    background: var(--surface); padding: 12px 16px; height: 60px;
    display: flex; align-items: center; justify-content: space-between;
    box-shadow: 0 1px 3px rgba(0,0,0,0.2); flex-shrink: 0;
}
.header-left { display: flex; align-items: center; gap: 15px; font-weight: 600; font-size: 18px; }
.btn-icon { background: none; border: none; color: var(--text-main); font-size: 20px; cursor: pointer; padding: 5px; }

/* --- 4. –°–ü–ò–°–ö–ò –ò –ß–ê–¢–´ --- */
.scroll-area { flex: 1; overflow-y: auto; }

.chat-row {
    display: flex; align-items: center; padding: 10px 15px;
    cursor: pointer; transition: 0.2s;
}
.chat-row:hover { background: #1c2a38; }
.avatar {
    width: 48px; height: 48px; border-radius: 50%; background: var(--primary);
    display: flex; align-items: center; justify-content: center;
    font-size: 20px; font-weight: bold; margin-right: 12px; color: #fff;
    background-size: cover; background-position: center;
}

.chat-info { flex: 1; min-width: 0; }
.chat-name { font-weight: 600; font-size: 16px; margin-bottom: 4px; }
.chat-preview { color: var(--text-sec); font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.chat-meta { font-size: 12px; color: var(--text-sec); margin-left: 10px; }

/* --- 5. –°–û–û–ë–©–ï–ù–ò–Ø --- */
.msg-list {
    flex: 1; overflow-y: auto; padding: 10px 15px;
    background-image: url("https://web.telegram.org/img/bg_0.png"); /* –¢–µ–º–Ω—ã–π –ø–∞—Ç—Ç–µ—Ä–Ω */
    background-color: var(--bg); background-blend-mode: overlay;
    display: flex; flex-direction: column; gap: 6px;
}

.bubble {
    max-width: 75%; padding: 8px 12px; border-radius: 12px;
    font-size: 15px; line-height: 1.4; position: relative;
    word-wrap: break-word; animation: popIn 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}
@keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }

.bubble.out { background: var(--msg-out); align-self: flex-end; border-bottom-right-radius: 2px; }
.bubble.in { background: var(--msg-in); align-self: flex-start; border-bottom-left-radius: 2px; }

.msg-time { font-size: 11px; color: rgba(255,255,255,0.5); float: right; margin-left: 8px; margin-top: 6px; }

/* --- 6. –í–í–û–î –¢–ï–ö–°–¢–ê --- */
.input-panel {
    background: var(--surface); padding: 8px; display: flex; gap: 8px; align-items: flex-end;
}
textarea {
    flex: 1; background: var(--bg); border: none; border-radius: 20px;
    padding: 10px 15px; color: #fff; resize: none; outline: none; height: 42px; font-size: 15px;
}
.send-btn {
    width: 42px; height: 42px; border-radius: 50%; background: var(--primary);
    border: none; color: #fff; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 18px;
}

/* --- 7. –ü–†–û–§–ò–õ–¨ –ò –§–û–†–ú–´ --- */
.form-box { padding: 30px; display: flex; flex-direction: column; gap: 15px; justify-content: center; height: 100%; text-align: center; }
input { background: var(--surface); border: 1px solid #333; padding: 12px; border-radius: 8px; color: white; width: 100%; outline: none; }
.btn-main { background: var(--primary); color: white; border: none; padding: 12px; border-radius: 8px; font-weight: bold; cursor: pointer; width: 100%; }

/* --- 8. –ö–û–ù–¢–ï–ö–°–¢–ù–û–ï –ú–ï–ù–Æ (–£–î–ê–õ–ï–ù–ò–ï) --- */
#contextMenu {
    display: none; position: absolute; background: var(--surface);
    border-radius: 8px; padding: 5px; box-shadow: 0 4px 15px rgba(0,0,0,0.5);
    z-index: 100; width: 150px;
}
.ctx-item { padding: 10px; cursor: pointer; color: var(--red); font-weight: 500; }
.ctx-item:hover { background: rgba(255,255,255,0.05); }

/* --- 9. Floating Action Button --- */
.fab {
    position: absolute; bottom: 20px; right: 20px; width: 56px; height: 56px;
    background: var(--primary); border-radius: 50%; color: white;
    display: flex; align-items: center; justify-content: center; font-size: 24px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.3); cursor: pointer;
}
</style>
</head>
<body>

<div class="app">
    
    <div id="scr-auth" class="screen active">
        <div class="form-box">
            <h1 style="color: var(--primary);">DEX</h1>
            <input id="authLogin" placeholder="–ü—Ä–∏–¥—É–º–∞–π—Ç–µ –Ω–∏–∫–Ω–µ–π–º">
            <input id="authPass" type="password" placeholder="–ü–∞—Ä–æ–ª—å">
            <button class="btn-main" onclick="Auth.login()">–í–æ–π—Ç–∏ / –°–æ–∑–¥–∞—Ç—å</button>
        </div>
    </div>

    <div id="scr-home" class="screen">
        <header>
            <div class="header-left">
                <div class="btn-icon" onclick="Nav.to('profile')">‚ò∞</div>
                <span>–ß–∞—Ç—ã</span>
            </div>
            <div class="btn-icon" onclick="Nav.to('search')">üîç</div>
        </header>
        <div class="scroll-area" id="chatList"></div>
        <div class="fab" onclick="Nav.to('search')">‚úé</div>
    </div>

    <div id="scr-chat" class="screen">
        <header>
            <div class="header-left">
                <div class="btn-icon" onclick="Nav.back()">‚Üê</div>
                <div id="chatHeaderName">User</div>
            </div>
            <div id="chatHeaderAvatar" class="avatar" style="width:32px; height:32px; font-size:14px;"></div>
        </header>
        <div class="msg-list" id="msgContainer"></div>
        <div class="input-panel">
            <textarea id="msgInput" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..."></textarea>
            <button class="send-btn" onclick="Chat.send()">‚û§</button>
        </div>
        <div id="contextMenu">
            <div class="ctx-item" onclick="Chat.deleteMsg()">–£–¥–∞–ª–∏—Ç—å</div>
            <div class="ctx-item" style="color: var(--text-sec)" onclick="Chat.closeCtx()">–û—Ç–º–µ–Ω–∞</div>
        </div>
    </div>

    <div id="scr-search" class="screen">
        <header>
            <div class="header-left"><div class="btn-icon" onclick="Nav.back()">‚Üê</div> –ü–æ–∏—Å–∫</div>
        </header>
        <div style="padding: 10px;">
            <input id="searchInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∏–∫–Ω–µ–π–º..." oninput="Search.find()">
        </div>
        <div class="scroll-area" id="searchResult"></div>
    </div>

    <div id="scr-profile" class="screen">
        <header>
            <div class="header-left"><div class="btn-icon" onclick="Nav.back()">‚Üê</div> –ü—Ä–æ—Ñ–∏–ª—å</div>
        </header>
        <div class="form-box" style="justify-content: flex-start;">
            <div id="profAvatar" class="avatar" style="width:100px; height:100px; margin: 0 auto; font-size: 40px;"></div>
            <h2 id="profName"></h2>
            
            <label style="text-align:left; color: var(--text-sec); font-size:12px;">–°—Å—ã–ª–∫–∞ –Ω–∞ –∞–≤–∞—Ç–∞—Ä–∫—É (URL)</label>
            <input id="profUrl" placeholder="https://...">
            <button class="btn-main" onclick="Profile.save()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ñ–æ—Ç–æ</button>
            <button class="btn-main" style="background: #333; margin-top: 20px;" onclick="Auth.logout()">–í—ã–π—Ç–∏</button>
        </div>
    </div>

</div>

<script>
// === 1. –ë–ê–ó–ê –î–ê–ù–ù–´–• –ò –°–û–°–¢–û–Ø–ù–ò–ï ===
const DB = {
    data: JSON.parse(localStorage.getItem('dex_db_v3')) || { users: {}, chats: {} },
    save() { localStorage.setItem('dex_db_v3', JSON.stringify(this.data)); },
    
    // –ü–æ–ª—É—á–∏—Ç—å ID —á–∞—Ç–∞ –º–µ–∂–¥—É –¥–≤—É–º—è —é–∑–µ—Ä–∞–º–∏ (–≤—Å–µ–≥–¥–∞ –æ–¥–∏–Ω–∞–∫–æ–≤—ã–π: "bob_alice")
    getChatId(u1, u2) { return [u1, u2].sort().join('_'); }
};

const State = { me: null, activeChat: null, targetMsg: null };

// === 2. –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø ===
const Auth = {
    login() {
        const u = authLogin.value.trim();
        const p = authPass.value.trim();
        if(!u || !p) return alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª—è");
        
        if(!DB.data.users[u]) {
            // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
            DB.data.users[u] = { pass: p, avatar: '' };
            // –°–æ–∑–¥–∞–µ–º —á–∞—Ç —Å —Å–æ–±–æ–π
            const selfChatId = DB.getChatId(u, u);
            DB.data.chats[selfChatId] = [];
            DB.save();
        } else if(DB.data.users[u].pass !== p) {
            return alert("–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å");
        }
        
        State.me = u;
        localStorage.setItem('dex_user', u);
        Home.render();
        Nav.to('home');
        authLogin.value = ''; authPass.value = '';
    },
    logout() {
        localStorage.removeItem('dex_user');
        location.reload();
    }
};

// === 3. –ù–ê–í–ò–ì–ê–¶–ò–Ø ===
const Nav = {
    history: [],
    to(screen) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById('scr-' + screen).classList.add('active');
        if(screen !== 'auth' && screen !== 'home') this.history.push(screen);
        if(screen === 'profile') Profile.render();
    },
    back() {
        this.history.pop();
        const prev = this.history.length > 0 ? this.history[this.history.length-1] : 'home';
        this.to(prev === 'chat' ? 'home' : prev); // –§–∏–∫—Å –ª–æ–≥–∏–∫–∏ –≤–æ–∑–≤—Ä–∞—Ç–∞
    }
};

// === 4. –ì–õ–ê–í–ù–´–ô –≠–ö–†–ê–ù (–°–ü–ò–°–û–ö –ß–ê–¢–û–í) ===
const Home = {
    render() {
        const list = document.getElementById('chatList');
        list.innerHTML = "";
        
        // 1. –°–Ω–∞—á–∞–ª–∞ "–ò–∑–±—Ä–∞–Ω–Ω–æ–µ"
        this.addChatRow(list, State.me, "Saved Messages", "‚≠ê");

        // 2. –ò—â–µ–º —á–∞—Ç—ã, –≥–¥–µ –µ—Å—Ç—å –º—ã
        Object.keys(DB.data.chats).forEach(chatId => {
            const members = chatId.split('_');
            if(members.includes(State.me) && chatId !== State.me + '_' + State.me) {
                const otherUser = members[0] === State.me ? members[1] : members[0];
                this.addChatRow(list, otherUser, otherUser, null);
            }
        });
    },
    addChatRow(container, userId, displayName, iconOverride) {
        const msgs = DB.data.chats[DB.getChatId(State.me, userId)] || [];
        const lastMsg = msgs.length ? msgs[msgs.length-1] : {text: "–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π", time: ""};
        
        const userObj = DB.data.users[userId];
        const avatarStyle = userObj?.avatar ? `background-image: url('${userObj.avatar}')` : '';
        const char = iconOverride || userId[0].toUpperCase();

        const row = document.createElement('div');
        row.className = 'chat-row';
        row.onclick = () => Chat.open(userId);
        row.innerHTML = `
            <div class="avatar" style="${avatarStyle}">${userObj?.avatar ? '' : char}</div>
            <div class="chat-info">
                <div style="display:flex; justify-content:space-between">
                    <div class="chat-name">${displayName}</div>
                    <div class="chat-meta">${lastMsg.time}</div>
                </div>
                <div class="chat-preview">${lastMsg.text}</div>
            </div>
        `;
        container.appendChild(row);
    }
};

// === 5. –ß–ê–¢ –ò –°–û–û–ë–©–ï–ù–ò–Ø ===
const Chat = {
    partner: null,
    
    open(partnerId) {
        this.partner = partnerId;
        State.activeChat = DB.getChatId(State.me, partnerId);
        
        // UI –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
        const isSelf = partnerId === State.me;
        chatHeaderName.innerText = isSelf ? "–ò–∑–±—Ä–∞–Ω–Ω–æ–µ" : partnerId;
        
        // –ê–≤–∞—Ç–∞—Ä –≤ —Ö–µ–¥–µ—Ä–µ
        const u = DB.data.users[partnerId];
        chatHeaderAvatar.innerText = u.avatar ? '' : (isSelf ? '‚≠ê' : partnerId[0].toUpperCase());
        chatHeaderAvatar.style.backgroundImage = u.avatar ? `url('${u.avatar}')` : 'none';

        Nav.to('chat');
        this.render();
    },

    render() {
        const msgs = DB.data.chats[State.activeChat] || [];
        const container = document.getElementById('msgContainer');
        container.innerHTML = "";
        
        msgs.forEach((m, idx) => {
            const div = document.createElement('div');
            div.className = `bubble ${m.from === State.me ? 'out' : 'in'}`;
            div.innerHTML = `${m.text}<span class="msg-time">${m.time}</span>`;
            
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–∞–≤–æ–≥–æ –∫–ª–∏–∫–∞ (—É–¥–∞–ª–µ–Ω–∏–µ)
            div.oncontextmenu = (e) => {
                e.preventDefault();
                if(m.from === State.me) { // –ú–æ–∂–Ω–æ —É–¥–∞–ª—è—Ç—å —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏
                    State.targetMsg = idx;
                    const menu = document.getElementById('contextMenu');
                    menu.style.display = 'block';
                    menu.style.left = e.pageX + 'px';
                    menu.style.top = e.pageY + 'px';
                }
            };
            container.appendChild(div);
        });
        container.scrollTop = container.scrollHeight;
    },

    send() {
        const text = msgInput.value.trim();
        if(!text) return;
        
        if(!DB.data.chats[State.activeChat]) DB.data.chats[State.activeChat] = [];
        
        const time = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        DB.data.chats[State.activeChat].push({ from: State.me, text, time });
        DB.save();
        
        msgInput.value = "";
        this.render();
    },

    deleteMsg() {
        if(State.targetMsg !== null) {
            DB.data.chats[State.activeChat].splice(State.targetMsg, 1);
            DB.save();
            this.render();
        }
        this.closeCtx();
    },

    closeCtx() {
        document.getElementById('contextMenu').style.display = 'none';
        State.targetMsg = null;
    }
};

// === 6. –ü–û–ò–°–ö ===
const Search = {
    find() {
        const q = searchInput.value.trim().toLowerCase();
        const res = document.getElementById('searchResult');
        res.innerHTML = "";
        if(!q) return;

        Object.keys(DB.data.users).forEach(u => {
            if(u.toLowerCase().includes(q)) {
                const div = document.createElement('div');
                div.className = 'chat-row';
                div.innerHTML = `
                    <div class="avatar">${u[0].toUpperCase()}</div>
                    <div class="chat-name">${u}</div>
                `;
                div.onclick = () => Chat.open(u);
                res.appendChild(div);
            }
        });
    }
};

// === 7. –ü–†–û–§–ò–õ–¨ ===
const Profile = {
    render() {
        const u = DB.data.users[State.me];
        profName.innerText = State.me;
        profUrl.value = u.avatar || "";
        
        profAvatar.innerText = u.avatar ? "" : State.me[0].toUpperCase();
        profAvatar.style.backgroundImage = u.avatar ? `url('${u.avatar}')` : 'none';
    },
    save() {
        const url = profUrl.value.trim();
        DB.data.users[State.me].avatar = url;
        DB.save();
        alert("–ê–≤–∞—Ç–∞—Ä –æ–±–Ω–æ–≤–ª–µ–Ω!");
        this.render();
    }
};

// === INIT ===
document.onclick = (e) => {
    if(!e.target.closest('.bubble')) Chat.closeCtx();
};

if(localStorage.getItem('dex_user')) {
    State.me = localStorage.getItem('dex_user');
    Home.render();
    Nav.to('home');
}
</script>
</body>
</html>

