<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DEX</title>

<style>
*{box-sizing:border-box}
body{
  margin:0;
  font-family:system-ui,Roboto;
  background:#0e1621;
  color:#fff;
}
.app{
  max-width:420px;
  margin:auto;
  min-height:100vh;
  background:#0e1621;
}
header{
  padding:16px;
  font-size:22px;
  font-weight:600;
  text-align:center;
  background:#17212b;
}
.section{display:none;padding:16px}
.section.active{display:block}

input,button{
  width:100%;
  padding:12px;
  margin-top:10px;
  border-radius:12px;
  border:none;
  font-size:15px;
}
input{background:#1f2933;color:#fff}
button{background:#2aabee;color:#fff}

.link{
  text-align:center;
  color:#2aabee;
  margin-top:12px;
  cursor:pointer;
}

/* chats */
.search{
  background:#1f2933;
  border-radius:12px;
  padding:10px;
  margin-bottom:10px;
}
.chat{
  display:flex;
  gap:12px;
  padding:10px;
  border-radius:12px;
  cursor:pointer;
}
.chat:hover{background:#1f2933}
.avatar{
  width:48px;height:48px;
  border-radius:50%;
  background:#2aabee;
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:700;
  overflow:hidden;
}
.avatar img{width:100%;height:100%;object-fit:cover}
.chat-info{flex:1}
.chat-name{font-weight:600}
.chat-last{font-size:13px;color:#9ca3af}
.star{color:#facc15}

/* messages */
.messages{height:65vh;overflow-y:auto;padding:10px}
.msg{
  max-width:75%;
  padding:8px 12px;
  border-radius:14px;
  margin-bottom:8px;
}
.me{background:#2aabee;margin-left:auto}
.other{background:#1f2933}
.msg img{max-width:100%;border-radius:10px}

.input-bar{
  display:flex;
  gap:6px;
  padding:10px;
}
.hidden{display:none}
</style>
</head>

<body>

<div class="app">

<header>DEX</header>

<!-- LOGIN -->
<div id="login" class="section active">
  <input id="lUser" placeholder="Username">
  <input id="lPass" type="password" placeholder="–ü–∞—Ä–æ–ª—å">
  <button onclick="login()">–í–æ–π—Ç–∏</button>
  <div class="link" onclick="openRegister()">–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</div>
</div>

<!-- REGISTER -->
<div id="register" class="section">
  <input id="rUser" placeholder="Username">
  <input id="rPass" type="password" placeholder="–ü–∞—Ä–æ–ª—å">
  <button onclick="register()">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
  <div class="link" onclick="openLogin()">–£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç? –í–æ–π—Ç–∏</div>
</div>

<!-- CHATS -->
<div id="chats" class="section">
  <input id="search" class="search" placeholder="–ü–æ–∏—Å–∫">
  <div id="chatList"></div>
</div>

<!-- CHAT -->
<div id="chatView" class="section">
  <div class="messages" id="messages"></div>
  <div class="input-bar">
    <input type="file" id="imgInput" hidden accept="image/*">
    <button onclick="imgInput.click()">üìé</button>
    <input id="msgText" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ">
    <button onclick="send()">‚û§</button>
  </div>
</div>

</div>

<script>
let users = JSON.parse(localStorage.getItem("dex_users")||"{}");
let current = localStorage.getItem("dex_current");
let chats = JSON.parse(localStorage.getItem("dex_chats")||"{}");
let favorites = JSON.parse(localStorage.getItem("dex_fav")||"[]");
let activeChat = null;

function openRegister(){
  login.classList.remove("active");
  register.classList.add("active");
}
function openLogin(){
  register.classList.remove("active");
  login.classList.add("active");
}

function register(){
  if(!rUser.value || !rPass.value) return alert("–ó–∞–ø–æ–ª–Ω–∏ –ø–æ–ª—è");
  if(users[rUser.value]) return alert("Username –∑–∞–Ω—è—Ç");
  users[rUser.value]={pass:rPass.value,ava:null};
  localStorage.setItem("dex_users",JSON.stringify(users));
  openLogin();
}

function login(){
  let u=users[lUser.value];
  if(!u || u.pass!==lPass.value) return alert("–ù–µ–≤–µ—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ");
  current=lUser.value;
  localStorage.setItem("dex_current",current);
  openChats();
}

function openChats(){
  login.classList.remove("active");
  register.classList.remove("active");
  chatsDiv.classList.add("active");
  renderChats();
}

function renderChats(){
  chatList.innerHTML="";
  let keys=[...new Set([...favorites,...Object.keys(chats)])];
  keys.filter(k=>k.includes(search.value)).forEach(u=>{
    let fav=favorites.includes(u);
    chatList.innerHTML+=`
    <div class="chat" onclick="openChat('${u}')">
      <div class="avatar">${users[u]?.ava?`<img src="${users[u].ava}">`:u[0]}</div>
      <div class="chat-info">
        <div class="chat-name">${u} ${fav?"‚≠ê":""}</div>
        <div class="chat-last">${chats[u]?.slice(-1)[0]?.text||""}</div>
      </div>
    </div>`;
  });
}

search.oninput=renderChats;

function openChat(u){
  activeChat=u;
  if(!chats[u]) chats[u]=[];
  chatsDiv.classList.remove("active");
  chatView.classList.add("active");
  renderMsgs();
}

function renderMsgs(){
  messages.innerHTML="";
  chats[activeChat].forEach(m=>{
    messages.innerHTML+=`
    <div class="msg ${m.from===current?'me':'other'}">
      ${m.text||""}
      ${m.img?`<img src="${m.img}">`:""}
    </div>`;
  });
}

function send(){
  chats[activeChat].push({from:current,text:msgText.value});
  msgText.value="";
  save();
}

imgInput.onchange=e=>{
  let r=new FileReader();
  r.onload=()=>{
    chats[activeChat].push({from:current,img:r.result});
    save();
  };
  r.readAsDataURL(e.target.files[0]);
};

function save(){
  localStorage.setItem("dex_chats",JSON.stringify(chats));
  renderMsgs();
  renderChats();
}

if(current) openChats();
</script>

</body>
</html>
