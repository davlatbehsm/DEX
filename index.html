<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DEX Messenger</title>

<style>
:root {
  --bg:#0f1621;--card:#17212b;--primary:#5288c1;
  --text:#fff;--text-dim:#7f91a4;
  --out:#2b5278;--in:#182533;--red:#ff595a;
}
*{box-sizing:border-box}
body{margin:0;background:#000;font-family:-apple-system;color:var(--text)}
.app{max-width:500px;margin:auto;height:100vh;background:var(--bg);position:relative}

/* screens */
.screen{position:absolute;inset:0;display:none;flex-direction:column}
.screen.active{display:flex}

/* header */
header{height:56px;background:var(--card);display:flex;align-items:center;padding:0 14px}
.title{font-weight:700;font-size:18px}

/* content */
.content{flex:1;overflow-y:auto}

/* auth */
.center{flex:1;display:flex;flex-direction:column;justify-content:center;padding:30px;gap:14px;text-align:center}
input{padding:14px;border-radius:10px;border:1px solid #2f3b47;background:var(--card);color:#fff}
button{padding:14px;border:none;border-radius:10px;background:var(--primary);color:#fff;font-weight:700}

/* chat list */
.item{display:flex;gap:12px;padding:12px;border-bottom:1px solid #1c2733;cursor:pointer}
.avatar{width:48px;height:48px;border-radius:50%;background:var(--primary);
display:flex;align-items:center;justify-content:center;font-weight:700}
.preview{color:var(--text-dim);font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

/* chat */
.msgs{flex:1;padding:10px;display:flex;flex-direction:column;gap:6px}
.bubble{max-width:75%;padding:8px 12px;border-radius:14px}
.me{background:var(--out);align-self:flex-end}
.other{background:var(--in)}
.time{font-size:11px;color:#aaa;text-align:right;margin-top:2px}
.input{display:flex;gap:8px;padding:10px;background:var(--card)}
.input input{flex:1}

/* tabs */
.tabs{height:56px;background:var(--card);display:flex}
.tab{flex:1;text-align:center;padding:8px;font-size:12px;color:var(--text-dim)}
.tab.active{color:var(--primary)}
</style>
</head>

<body>
<div class="app">

<!-- AUTH -->
<div id="auth" class="screen active">
  <div class="center">
    <h1 style="color:var(--primary)">DEX</h1>
    <input id="nick" placeholder="Username">
    <button onclick="Core.login()">–í–æ–π—Ç–∏ / –°–æ–∑–¥–∞—Ç—å</button>
    <small style="color:#666">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏</small>
  </div>
</div>

<!-- MAIN -->
<div id="main" class="screen">
<header><div class="title" id="title">–ß–∞—Ç—ã</div></header>

<div id="chats" class="content"></div>

<div id="search" class="content" style="display:none;padding:10px">
<input id="searchIn" placeholder="–ü–æ–∏—Å–∫..." oninput="Core.search()">
<div id="searchRes"></div>
</div>

<div id="profile" class="content" style="display:none;padding:20px;text-align:center">
<div class="avatar" id="myAv" style="margin:auto;width:90px;height:90px;font-size:36px"></div>
<h2 id="myName"></h2>
<button onclick="Core.logout()" style="background:var(--red)">–í—ã–π—Ç–∏</button>
</div>

<div class="tabs">
<div class="tab active" onclick="Tabs.go('chats',this)">üí¨<br>–ß–∞—Ç—ã</div>
<div class="tab" onclick="Tabs.go('search',this)">üîç<br>–ü–æ–∏—Å–∫</div>
<div class="tab" onclick="Tabs.go('profile',this)">üë§<br>–ü—Ä–æ—Ñ–∏–ª—å</div>
</div>
</div>

<!-- CHAT -->
<div id="chat" class="screen">
<header>
<div onclick="Chat.close()" style="margin-right:10px;cursor:pointer">‚Üê</div>
<div class="title" id="chatName"></div>
</header>

<div id="msgs" class="msgs"></div>

<div class="input">
<input id="msg" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ">
<button onclick="Chat.send()">‚û§</button>
</div>
</div>

</div>

<script>
const DB={
user:localStorage.getItem('dex_user'),
data:JSON.parse(localStorage.getItem('dex_data'))||{users:{},chats:{}},
save(){
localStorage.setItem('dex_data',JSON.stringify(this.data))
if(this.user)localStorage.setItem('dex_user',this.user)
},
cid(a,b){return[a,b].sort().join('::')}
}

const Core={
login(){
const u=nick.value.trim()
if(!u)return alert("–í–≤–µ–¥–∏—Ç–µ –∏–º—è")
DB.user=u
if(!DB.data.users[u]){
DB.data.users[u]={}
DB.data.chats[DB.cid(u,u)]=[{from:'system',text:'‚≠ê –ò–∑–±—Ä–∞–Ω–Ω–æ–µ',time:''}]
}
DB.save()
UI.enter()
},
logout(){
localStorage.removeItem('dex_user')
location.reload()
},
search(){
const q=searchIn.value.toLowerCase()
searchRes.innerHTML=''
Object.keys(DB.data.users).forEach(u=>{
if(u!==DB.user && u.toLowerCase().includes(q)){
searchRes.innerHTML+=`
<div class="item" onclick="Chat.open('${u}')">
<div class="avatar">${u[0]}</div>
<div>${u}</div>
</div>`
}
})
}
}

const UI={
enter(){
auth.classList.remove('active')
main.classList.add('active')
myName.innerText=DB.user
myAv.innerText=DB.user[0]
ChatList.render()
}
}

const ChatList={
render(){
chats.innerHTML=''
Object.keys(DB.data.chats).forEach(id=>{
if(id.includes(DB.user)){
const p=id.split('::').find(x=>x!==DB.user)||DB.user
const last=DB.data.chats[id].slice(-1)[0]
chats.innerHTML+=`
<div class="item" onclick="Chat.open('${p}')">
<div class="avatar">${p[0]}</div>
<div>
<b>${p===DB.user?'–ò–∑–±—Ä–∞–Ω–Ω–æ–µ':p}</b>
<div class="preview">${last.text}</div>
</div>
</div>`
}
})
}
}

const Chat={
with:null,
open(u){
this.with=u
chatName.innerText=u===DB.user?'–ò–∑–±—Ä–∞–Ω–Ω–æ–µ':u
chat.classList.add('active')
this.render()
},
close(){
chat.classList.remove('active')
ChatList.render()
},
render(){
msgs.innerHTML=''
(DB.data.chats[DB.cid(DB.user,this.with)]||[]).forEach(m=>{
msgs.innerHTML+=`
<div class="bubble ${m.from===DB.user?'me':'other'}">
${m.text}
<div class="time">${m.time}</div>
</div>`
})
msgs.scrollTop=msgs.scrollHeight
},
send(){
if(!msg.value)return
const id=DB.cid(DB.user,this.with)
DB.data.chats[id]=DB.data.chats[id]||[]
DB.data.chats[id].push({
from:DB.user,
text:msg.value,
time:new Date().toLocaleTimeString().slice(0,5)
})
msg.value=''
DB.save()
this.render()
}
}

const Tabs={
go(n,el){
document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'))
el.classList.add('active')
;['chats','search','profile'].forEach(v=>{
document.getElementById(v).style.display=v===n?'block':'none'
})
title.innerText=n==='chats'?'–ß–∞—Ç—ã':n==='search'?'–ü–æ–∏—Å–∫':'–ü—Ä–æ—Ñ–∏–ª—å'
if(n==='chats')ChatList.render()
}
}

if(DB.user && DB.data.users[DB.user]){
UI.enter()
}else{
localStorage.removeItem('dex_user')
}
</script>
</body>
</html>
