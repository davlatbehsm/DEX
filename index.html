<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>DEX 6.1</title>

<style>
:root{
 --bg:#0f1621;--card:#17212b;--primary:#5288c1;
 --text:#fff;--text-dim:#7f91a4;
 --msg-out:#2b5278;--msg-in:#182533;--red:#ff595a
}
*{box-sizing:border-box}
body{margin:0;background:#000;color:var(--text);font-family:-apple-system,sans-serif;height:100dvh}
.app{max-width:500px;height:100%;margin:auto;background:var(--bg);display:flex;flex-direction:column;position:relative}

/* screens */
.screen{position:absolute;inset:0;background:var(--bg);display:none;flex-direction:column}
.screen.active{display:flex}

/* header */
header{height:60px;background:var(--card);display:flex;align-items:center;padding:0 16px;font-size:20px;font-weight:600}

/* content */
.content{flex:1;overflow-y:auto;padding-bottom:80px}

/* tabs */
.tab-bar{height:65px;background:var(--card);display:flex}
.tab{flex:1;text-align:center;font-size:12px;color:var(--text-dim);padding-top:8px;cursor:pointer}
.tab.active{color:var(--primary)}

/* list */
.list-item{display:flex;align-items:center;padding:12px 16px;border-bottom:1px solid #1c252f;cursor:pointer}
.avatar{width:52px;height:52px;border-radius:50%;background:var(--primary);display:flex;align-items:center;justify-content:center;font-size:20px;font-weight:bold;margin-right:15px}
.preview{font-size:14px;color:var(--text-dim);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

/* messages */
.bubble{max-width:80%;padding:10px 14px;border-radius:16px;margin-bottom:8px}
.me{background:var(--msg-out);margin-left:auto}
.other{background:var(--msg-in)}
.time{font-size:10px;color:#aaa;float:right;margin-left:8px}

/* inputs */
input{background:var(--card);border:1px solid #2f3b47;color:#fff;padding:15px;border-radius:12px;font-size:16px;width:100%}
.btn{background:var(--primary);border:none;color:#fff;padding:15px;border-radius:12px;font-weight:bold;cursor:pointer}
.btn-sec{background:#242f3d}

/* modal */
.modal{position:fixed;inset:0;background:rgba(0,0,0,.8);display:none;align-items:center;justify-content:center;z-index:100}
.modal-box{background:var(--card);padding:20px;border-radius:15px;width:100%;max-width:400px}
</style>
</head>

<body>
<div class="app">

<!-- AUTH -->
<div id="scr-auth" class="screen">
  <div style="padding:30px;margin:auto;width:100%">
    <h1 style="text-align:center;color:var(--primary);font-size:40px">DEX</h1>
    <input id="inUser" placeholder="–õ–æ–≥–∏–Ω">
    <input id="inPass" type="password" placeholder="–ü–∞—Ä–æ–ª—å" style="margin-top:10px">
    <button class="btn" style="margin-top:15px" onclick="Auth.login()">–í–æ–π—Ç–∏ / –°–æ–∑–¥–∞—Ç—å</button>
  </div>
</div>

<!-- MAIN -->
<div id="scr-main" class="screen">
<header id="mainTitle">–ß–∞—Ç—ã</header>

<div id="view-chats" class="content"></div>

<div id="view-search" class="content" style="display:none;padding:15px">
  <input id="searchIn" placeholder="–ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è" oninput="Search.go()">
  <div id="searchRes"></div>
</div>

<div id="view-prof" class="content" style="display:none;padding:20px;text-align:center">
  <div id="myAv" class="avatar" style="width:100px;height:100px;margin:auto;font-size:40px"></div>
  <h2 id="myName"></h2>
  <button class="btn btn-sec" onclick="Sync.export()">üì§ –ü–æ–¥–µ–ª–∏—Ç—å—Å—è ID</button>
  <button class="btn btn-sec" style="margin-top:10px" onclick="Sync.import()">üì• –î–æ–±–∞–≤–∏—Ç—å –¥—Ä—É–≥–∞</button>
  <button class="btn" style="margin-top:20px;background:var(--red)" onclick="Auth.logout()">–í—ã–π—Ç–∏</button>
</div>

<div class="tab-bar">
  <div class="tab active" onclick="Tabs.go('chats',this)">üí¨<br>–ß–∞—Ç—ã</div>
  <div class="tab" onclick="Tabs.go('search',this)">üîç<br>–ü–æ–∏—Å–∫</div>
  <div class="tab" onclick="Tabs.go('prof',this)">üë§<br>–ü—Ä–æ—Ñ–∏–ª—å</div>
</div>
</div>

<!-- CHAT -->
<div id="scr-chat" class="screen">
<header>
  <span style="cursor:pointer" onclick="Chat.close()">‚Üê</span>
  <span id="chatName" style="margin-left:15px"></span>
</header>
<div id="msgList" class="content" style="padding:15px"></div>
<div style="padding:10px;display:flex;gap:10px;background:var(--card)">
  <input id="msgIn" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ">
  <button class="btn" style="width:50px" onclick="Chat.send()">‚û§</button>
</div>
</div>

<!-- MODAL -->
<div id="modal" class="modal">
<div class="modal-box">
<h3 id="modalTitle"></h3>
<p id="modalText" style="word-break:break-all;font-size:12px;color:var(--text-dim)"></p>
<input id="modalIn" style="display:none;margin-top:10px">
<button class="btn" style="margin-top:10px" id="modalBtn">OK</button>
<button class="btn btn-sec" style="margin-top:10px" onclick="modal.style.display='none'">–û—Ç–º–µ–Ω–∞</button>
</div>
</div>

</div>

<script>
const DB={
 me:localStorage.getItem('dex_me'),
 data:JSON.parse(localStorage.getItem('dex_v6'))||{users:{},chats:{}},
 save(){localStorage.setItem('dex_v6',JSON.stringify(this.data));if(this.me)localStorage.setItem('dex_me',this.me)},
 cid(a,b){return[a,b].sort().join('::')}
};

const Auth={
 login(){
  const u=inUser.value.trim(),p=inPass.value.trim();
  if(!u||!p)return alert("–ó–∞–ø–æ–ª–Ω–∏ –ø–æ–ª—è");
  if(!DB.data.users[u]){
   DB.data.users[u]={pass:p};
   DB.data.chats[DB.cid(u,u)]=[{f:u,t:"‚≠ê –ò–∑–±—Ä–∞–Ω–Ω–æ–µ",d:""}];
  }else if(DB.data.users[u].pass!==p)return alert("–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å");
  DB.me=u;DB.save();UI.enter();
 },
 logout(){localStorage.clear();location.reload()}
};

const UI={
 enter(){
  scr_auth.classList.remove('active');
  scr_main.classList.add('active');
  myName.innerText=DB.me;
  myAv.innerText=DB.me[0].toUpperCase();
  Tabs.renderChats();
 }
};

const Tabs={
 go(t,el){
  document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
  el.classList.add('active');
  ['chats','search','prof'].forEach(v=>document.getElementById('view-'+v).style.display=v==t?'block':'none');
  mainTitle.innerText=t=='chats'?'–ß–∞—Ç—ã':t=='search'?'–ü–æ–∏—Å–∫':'–ü—Ä–æ—Ñ–∏–ª—å';
  if(t=='chats')this.renderChats();
 },
 renderChats(){
  view_chats.innerHTML="";
  Object.keys(DB.data.chats).forEach(id=>{
   if(!id.includes(DB.me))return;
   const p=id.split('::').find(x=>x!==DB.me)||DB.me;
   const last=DB.data.chats[id].slice(-1)[0];
   view_chats.innerHTML+=`
   <div class="list-item" onclick="Chat.open('${p}')">
    <div class="avatar">${p[0].toUpperCase()}</div>
    <div>
     <b>${p==DB.me?'‚≠ê –ò–∑–±—Ä–∞–Ω–Ω–æ–µ':p}</b>
     <div class="preview">${last.t}</div>
    </div>
   </div>`;
  });
 }
};

const Chat={
 target:null,
 open(u){
  this.target=u;
  chatName.innerText=u==DB.me?'–ò–∑–±—Ä–∞–Ω–Ω–æ–µ':u;
  scr_chat.classList.add('active');
  this.render();
 },
 close(){scr_chat.classList.remove('active');Tabs.renderChats()},
 render(){
  msgList.innerHTML="";
  const cid=DB.cid(DB.me,this.target);
  (DB.data.chats[cid]||[]).forEach(m=>{
   msgList.innerHTML+=`<div class="bubble ${m.f==DB.me?'me':'other'}">${m.t}<span class="time">${m.d}</span></div>`;
  });
 },
 send(){
  const t=msgIn.value.trim();if(!t)return;
  const cid=DB.cid(DB.me,this.target);
  if(!DB.data.chats[cid])DB.data.chats[cid]=[];
  DB.data.chats[cid].push({f:DB.me,t,d:new Date().toLocaleTimeString().slice(0,5)});
  DB.save();msgIn.value="";this.render();
 }
};

const Search={
 go(){
  searchRes.innerHTML="";
  const q=searchIn.value.toLowerCase();
  if(!q)return;
  Object.keys(DB.data.users).forEach(u=>{
   if(u.toLowerCase().includes(q)&&u!==DB.me)
    searchRes.innerHTML+=`<div class="list-item" onclick="Chat.open('${u}')"><div class="avatar">${u[0]}</div>${u}</div>`;
  });
 }
};

const Sync={
 export(){
  modal.style.display='flex';
  modalTitle.innerText="–¢–≤–æ–π ID";
  modalText.innerText=btoa(JSON.stringify({u:DB.me}));
  modalIn.style.display='none';
  modalBtn.onclick=()=>modal.style.display='none';
 },
 import(){
  modal.style.display='flex';
  modalTitle.innerText="ID –¥—Ä—É–≥–∞";
  modalText.innerText="–í—Å—Ç–∞–≤—å –∫–æ–¥";
  modalIn.style.display='block';
  modalBtn.onclick=()=>{
   try{
    const d=JSON.parse(atob(modalIn.value));
    if(!DB.data.users[d.u])DB.data.users[d.u]={pass:'external'};
    DB.save();modal.style.display='none';alert("–î—Ä—É–≥ –¥–æ–±–∞–≤–ª–µ–Ω!");
   }catch{alert("–û—à–∏–±–∫–∞")}
  };
 }
};

if(DB.me)UI.enter();else scr_auth.classList.add('active');
</script>
</body>
</html>
